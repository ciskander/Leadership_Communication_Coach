{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/mvp.v0.2.1.json",
  "title": "Leadership Coaching Analysis Output (mvp.v0.2.1)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "meta",
    "context",
    "evaluation_summary",
    "pattern_snapshot",
    "coaching_output",
    "experiment_tracking",
    "evidence_spans"
  ],
  "properties": {
    "schema_version": { "const": "mvp.v0.2.1" },
    "meta": { "$ref": "#/$defs/Meta" },
    "context": {
      "oneOf": [
        { "$ref": "#/$defs/SingleMeetingContext" },
        { "$ref": "#/$defs/BaselinePackContext" }
      ]
    },
    "evaluation_summary": { "$ref": "#/$defs/EvaluationSummary" },
    "pattern_snapshot": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/PatternMeasurementUnion" }
    },
    "coaching_output": { "$ref": "#/$defs/CoachingOutput" },
    "experiment_tracking": { "$ref": "#/$defs/ExperimentTracking" },
    "evidence_spans": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/EvidenceSpan" }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "meta": {
            "properties": { "analysis_type": { "const": "single_meeting" } },
            "required": ["analysis_type"]
          }
        }
      },
      "then": {
        "properties": {
          "context": { "$ref": "#/$defs/SingleMeetingContext" },
          "experiment_tracking": { "$ref": "#/$defs/ExperimentTrackingSingleMeeting" }
        }
      }
    },
    {
      "if": {
        "properties": {
          "meta": {
            "properties": { "analysis_type": { "const": "baseline_pack" } },
            "required": ["analysis_type"]
          }
        }
      },
      "then": {
        "properties": {
          "context": { "$ref": "#/$defs/BaselinePackContext" },
          "experiment_tracking": { "$ref": "#/$defs/ExperimentTrackingBaselinePack" }
        }
      }
    }
  ],
  "$defs": {
    "Meta": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "analysis_id",
        "analysis_type",
        "generated_at",
        "taxonomy_version",
        "output_mode"
      ],
      "properties": {
        "analysis_id": { "type": "string", "pattern": "^A-[0-9]{6}$" },
        "analysis_type": { "type": "string", "enum": ["single_meeting", "baseline_pack"] },
        "generated_at": { "type": "string", "format": "date-time" },
        "taxonomy_version": { "type": "string", "const": "v1.4" },
        "output_mode": { "type": "string", "const": "coaching_first_2s1e" },
        "schema_hash": { "type": ["string", "null"] }
      }
    },
    "SingleMeetingContext": {
      "type": "object",
      "additionalProperties": false,
      "required": ["meeting_id", "meeting_type", "target_role"],
      "properties": {
        "meeting_id": { "type": "string", "pattern": "^M-[0-9]{6}$" },
        "meeting_type": {
          "type": "string",
          "enum": [
            "exec_staff",
            "board",
            "all_hands",
            "cross_functional",
            "project_review",
            "sprint_planning",
			"sprint_retrospective",
			"stand_up",
            "incident_review",
            "client_call",
            "one_on_one",
            "other"
          ]
        },
        "target_role": {
          "type": "string",
          "enum": ["chair", "presenter", "participant", "manager_1to1", "report_1to1"]
        },
        "meeting_date": { "type": ["string", "null"], "format": "date" }
      }
    },
    "BaselinePackContext": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "baseline_pack_id",
        "pack_size",
        "target_role",
        "role_consistency",
        "meeting_type_consistency",
        "meetings"
      ],
      "properties": {
        "baseline_pack_id": { "type": "string", "pattern": "^BP-[0-9]{6}$" },
        "pack_size": { "type": "integer", "minimum": 1, "maximum": 20 },
        "target_role": {
          "type": "string",
          "enum": ["chair", "presenter", "participant", "manager_1to1", "report_1to1", "mixed"]
        },
        "role_consistency": { "type": "boolean" },
        "meeting_type_consistency": { "type": "boolean" },
        "meetings": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["meeting_id", "meeting_type"],
            "properties": {
              "meeting_id": { "type": "string", "pattern": "^M-[0-9]{6}$" },
              "meeting_type": {
                "type": "string",
                "enum": [
                  "exec_staff",
                  "board",
                  "all_hands",
                  "cross_functional",
                  "project_review",
                  "sprint_planning",
				  "sprint_retrospective",
				  "stand_up",
                  "incident_review",
                  "client_call",
                  "one_on_one",
                  "other"
                ]
              }
            }
          }
        }
      }
    },
    "PatternId": {
      "type": "string",
      "enum": [
        "agenda_clarity",
        "objective_signaling",
        "turn_allocation",
        "facilitative_inclusion",
        "decision_closure",
        "owner_timeframe_specification",
        "summary_checkback",
        "question_quality",
        "listener_response_quality",
        "conversational_balance"
      ]
    },
    "EvaluationSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "patterns_evaluated",
        "patterns_insufficient_signal",
        "patterns_not_evaluable"
      ],
      "properties": {
        "patterns_evaluated": {
          "type": "array",
          "items": { "$ref": "#/$defs/PatternId" },
          "uniqueItems": true
        },
        "patterns_insufficient_signal": {
          "type": "array",
          "items": { "$ref": "#/$defs/PatternId" },
          "uniqueItems": true
        },
        "patterns_not_evaluable": {
          "type": "array",
          "items": { "$ref": "#/$defs/PatternId" },
          "uniqueItems": true
        }
      }
    },
    "OpportunityReasonCode": {
      "type": "string",
      "enum": [
        "explicit_decision_point",
        "explicit_assignment",
        "agenda_transition",
        "question_to_target",
        "non_target_owned",
        "ambiguous_control",
        "insufficient_context",
        "other"
      ]
    },
    "OpportunityEvent": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "event_id",
        "turn_start_id",
        "turn_end_id",
        "target_control",
        "count_decision",
        "success",
        "reason_code"
      ],
      "properties": {
        "event_id": { "type": "string", "pattern": "^OE-[0-9]{3}$" },
        "turn_start_id": { "type": "integer", "minimum": 1 },
        "turn_end_id": { "type": "integer", "minimum": 1 },
        "target_control": { "type": "string", "enum": ["yes", "no", "unclear"] },
        "count_decision": { "type": "string", "enum": ["counted", "excluded"] },
        "success": { "type": "string", "enum": ["yes", "no", "na"] },
        "reason_code": { "$ref": "#/$defs/OpportunityReasonCode" },
        "notes": { "type": ["string", "null"] }
      }
    },
    "PatternMeasurementBase": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "pattern_id",
        "tier",
        "evaluable_status",
        "denominator_rule_id",
        "min_required_threshold",
        "evidence_span_ids"
      ],
      "properties": {
        "pattern_id": { "$ref": "#/$defs/PatternId" },
        "tier": { "type": "integer", "enum": [1, 2] },
        "evaluable_status": {
          "type": "string",
          "enum": ["evaluable", "insufficient_signal", "not_evaluable"]
        },
        "denominator_rule_id": { "type": "string", "minLength": 1 },
        "min_required_threshold": { "type": ["integer", "null"], "minimum": 0 },
        "opportunity_count": { "type": ["integer", "null"], "minimum": 0 },
        "evidence_span_ids": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "pattern": "^ES-[0-9]{3}$" },
          "uniqueItems": true
        },
        "notes": { "type": ["string", "null"] }
      }
    },
    "PatternMeasurementEvaluableNumeric": {
      "allOf": [
        { "$ref": "#/$defs/PatternMeasurementBase" },
        {
          "type": "object",
          "required": ["numerator", "denominator", "ratio"],
          "properties": {
            "evaluable_status": { "const": "evaluable" },
            "numerator": { "type": "integer", "minimum": 0 },
            "denominator": { "type": "integer", "minimum": 1 },
            "ratio": { "type": "number", "minimum": 0, "maximum": 1 },
            "opportunity_events": {
              "type": "array",
              "minItems": 0,
              "items": { "$ref": "#/$defs/OpportunityEvent" }
            },
            "opportunity_events_considered": { "type": "integer", "minimum": 0 },
            "opportunity_events_counted": { "type": "integer", "minimum": 0 }
          },
          "not": {
            "properties": { "pattern_id": { "const": "conversational_balance" } },
            "required": ["pattern_id"]
          }
        }
      ]
    },
    "PatternMeasurementInsufficientSignal": {
      "allOf": [
        { "$ref": "#/$defs/PatternMeasurementBase" },
        {
          "type": "object",
          "properties": { "evaluable_status": { "const": "insufficient_signal" } },
          "not": {
            "anyOf": [
              { "required": ["numerator"] },
              { "required": ["denominator"] },
              { "required": ["ratio"] },
              { "required": ["opportunity_events"] },
              { "required": ["opportunity_events_considered"] },
              { "required": ["opportunity_events_counted"] },
              {
                "properties": { "pattern_id": { "const": "conversational_balance" } },
                "required": ["pattern_id"]
              }
            ]
          }
        }
      ]
    },
    "PatternMeasurementNotEvaluable": {
      "allOf": [
        { "$ref": "#/$defs/PatternMeasurementBase" },
        {
          "type": "object",
          "properties": { "evaluable_status": { "const": "not_evaluable" } },
          "not": {
            "anyOf": [
              { "required": ["numerator"] },
              { "required": ["denominator"] },
              { "required": ["ratio"] },
              { "required": ["opportunity_events"] },
              { "required": ["opportunity_events_considered"] },
              { "required": ["opportunity_events_counted"] },
              {
                "properties": { "pattern_id": { "const": "conversational_balance" } },
                "required": ["pattern_id"]
              }
            ]
          }
        }
      ]
    },
    "ConversationalBalanceMeasurement": {
      "allOf": [
        { "$ref": "#/$defs/PatternMeasurementBase" },
        {
          "type": "object",
          "required": ["balance_assessment"],
          "properties": {
            "pattern_id": { "const": "conversational_balance" },
            "evaluable_status": { "const": "evaluable" },
            "balance_assessment": {
              "type": "string",
              "enum": ["over_indexed", "balanced", "under_indexed", "unclear"]
            }
          },
          "not": {
            "anyOf": [
              { "required": ["numerator"] },
              { "required": ["denominator"] },
              { "required": ["ratio"] },
              { "required": ["opportunity_events"] },
              { "required": ["opportunity_events_considered"] },
              { "required": ["opportunity_events_counted"] }
            ]
          }
        }
      ]
    },
    "PatternMeasurementUnion": {
      "oneOf": [
        { "$ref": "#/$defs/PatternMeasurementEvaluableNumeric" },
        { "$ref": "#/$defs/PatternMeasurementInsufficientSignal" },
        { "$ref": "#/$defs/PatternMeasurementNotEvaluable" },
        { "$ref": "#/$defs/ConversationalBalanceMeasurement" }
      ]
    },
    "CoachingItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["pattern_id", "message", "evidence_span_ids"],
      "properties": {
        "pattern_id": { "$ref": "#/$defs/PatternId" },
        "message": { "type": "string", "minLength": 1, "maxLength": 800 },
        "evidence_span_ids": {
          "type": "array",
          "items": { "type": "string", "pattern": "^ES-[0-9]{3}$" },
          "uniqueItems": true
        }
      }
    },
    "MicroExperiment": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "experiment_id",
        "title",
        "instruction",
        "success_marker",
        "pattern_id",
        "evidence_span_ids"
      ],
      "properties": {
        "experiment_id": { "type": "string", "pattern": "^EXP-[0-9]{6}$" },
        "title": { "type": "string", "minLength": 1, "maxLength": 140 },
        "instruction": { "type": "string", "minLength": 1, "maxLength": 600 },
        "success_marker": { "type": "string", "minLength": 1, "maxLength": 300 },
        "pattern_id": { "$ref": "#/$defs/PatternId" },
        "evidence_span_ids": {
          "type": "array",
          "items": { "type": "string", "pattern": "^ES-[0-9]{3}$" },
          "uniqueItems": true
        }
      }
    },
    "CoachingOutput": {
      "type": "object",
      "additionalProperties": false,
      "required": ["strengths", "focus", "micro_experiment"],
      "properties": {
        "strengths": {
          "type": "array",
          "minItems": 0,
          "maxItems": 2,
          "items": { "$ref": "#/$defs/CoachingItem" }
        },
        "focus": {
          "type": "array",
          "minItems": 1,
          "maxItems": 1,
          "items": { "$ref": "#/$defs/CoachingItem" }
        },
        "micro_experiment": {
          "type": "array",
          "minItems": 1,
          "maxItems": 1,
          "items": { "$ref": "#/$defs/MicroExperiment" }
        }
      }
    },
    "ActiveExperiment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["experiment_id", "status"],
      "properties": {
        "experiment_id": { "type": "string", "pattern": "^EXP-[0-9]{6}$" },
        "status": {
          "type": "string",
          "enum": ["none", "assigned", "active", "completed", "abandoned"]
        }
      }
    },
    "ExperimentDetection": {
      "type": "object",
      "additionalProperties": false,
      "required": ["experiment_id", "attempt", "count_attempts", "evidence_span_ids"],
      "properties": {
        "experiment_id": { "type": "string", "pattern": "^EXP-[0-9]{6}$" },
        "attempt": { "type": "string", "enum": ["no", "partial", "yes"] },
        "count_attempts": { "type": "integer", "minimum": 0 },
        "evidence_span_ids": {
          "type": "array",
          "items": { "type": "string", "pattern": "^ES-[0-9]{3}$" },
          "uniqueItems": true
        }
      }
    },
    "ExperimentTracking": {
      "type": "object",
      "additionalProperties": false,
      "required": ["active_experiment", "detection_in_this_meeting"],
      "properties": {
        "active_experiment": { "$ref": "#/$defs/ActiveExperiment" },
        "detection_in_this_meeting": {
          "oneOf": [{ "$ref": "#/$defs/ExperimentDetection" }, { "type": "null" }]
        }
      }
    },
    "ExperimentTrackingSingleMeeting": {
      "allOf": [
        { "$ref": "#/$defs/ExperimentTracking" },
        {
          "if": {
            "properties": {
              "active_experiment": {
                "properties": { "status": { "enum": ["assigned", "active"] } },
                "required": ["status"]
              }
            }
          },
          "then": {
            "properties": {
              "detection_in_this_meeting": { "$ref": "#/$defs/ExperimentDetection" }
            }
          },
          "else": {
            "properties": { "detection_in_this_meeting": { "type": "null" } }
          }
        }
      ]
    },
    "ExperimentTrackingBaselinePack": {
      "allOf": [
        { "$ref": "#/$defs/ExperimentTracking" },
        { "properties": { "detection_in_this_meeting": { "type": "null" } } }
      ]
    },
    "EvidenceSpan": {
      "type": "object",
      "additionalProperties": false,
      "required": ["evidence_span_id", "turn_start_id", "turn_end_id", "excerpt"],
      "properties": {
        "evidence_span_id": { "type": "string", "pattern": "^ES-[0-9]{3}$" },
        "meeting_id": { "type": ["string", "null"], "pattern": "^M-[0-9]{6}$" },
        "speaker_role": {
          "type": ["string", "null"],
          "enum": [
            "chair",
            "presenter",
            "participant",
            "manager_1to1",
            "report_1to1",
            null
          ]
        },
        "turn_start_id": { "type": "integer", "minimum": 1 },
        "turn_end_id": { "type": "integer", "minimum": 1 },
        "excerpt": { "type": "string", "minLength": 1, "maxLength": 1200 }
      }
    }
  }
}
